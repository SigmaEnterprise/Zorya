<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script>
(function() {
    // Helper function to determine the global object
    function getGlobalObject() {
        try {
            return (typeof window !== 'undefined') ? window : global;
        } catch (e) {
            return {};
        }
    }

    // Polyfills
    function polyfill() {
        if (typeof Symbol === 'undefined') {
            (function() {
                const Symbol = function(description) {
                    return `@@${description}`;
                };
                Symbol.iterator = Symbol('iterator');
                globalThis.Symbol = Symbol;
            })();
        }
        
        if (typeof Promise === 'undefined') {
            (function() {
                class MyPromise {
                    constructor(executor) {
                        this.callbacks = [];
                        this.state = 'pending';
                        this.result = null;

                        const resolve = (value) => {
                            this.state = 'fulfilled';
                            this.result = value;
                            this.callbacks.forEach(callback => callback(value));
                        };

                        const reject = (reason) => {
                            this.state = 'rejected';
                            this.result = reason;
                            this.callbacks.forEach(callback => callback(reason));
                        };

                        executor(resolve, reject);
                    }

                    then(callback) {
                        if (this.state === 'fulfilled') {
                            callback(this.result);
                        } else {
                            this.callbacks.push(callback);
                        }
                        return this;
                    }

                    catch(callback) {
                        if (this.state === 'rejected') {
                            callback(this.result);
                        } else {
                            this.callbacks.push(callback);
                        }
                        return this;
                    }

                    static resolve(value) {
                        return new MyPromise((resolve) => resolve(value));
                    }

                    static reject(reason) {
                        return new MyPromise((_, reject) => reject(reason));
                    }
                }
                globalThis.Promise = MyPromise;
            })();
        }

        if (typeof WeakMap === 'undefined') {
            (function() {
                class WeakMapPolyfill {
                    constructor() {
                        this.items = [];
                    }

                    set(key, value) {
                        const index = this.items.findIndex(item => item[0] === key);
                        if (index === -1) {
                            this.items.push([key, value]);
                        } else {
                            this.items[index][1] = value;
                        }
                    }

                    get(key) {
                        const index = this.items.findIndex(item => item[0] === key);
                        return index !== -1 ? this.items[index][1] : undefined;
                    }

                    has(key) {
                        return this.items.some(item => item[0] === key);
                    }

                    delete(key) {
                        const index = this.items.findIndex(item => item[0] === key);
                        if (index !== -1) {
                            this.items.splice(index, 1);
                        }
                    }
                }
                globalThis.WeakMap = WeakMapPolyfill;
            })();
        }
    }

    // WebSocket connection
    function connectWebSocket() {
        const socket = new WebSocket("wss://example.com/socket");
        
        socket.onopen = () => {
            console.log("WebSocket connection established.");
        };

        socket.onmessage = (event) => {
            handleMessage(event.data);
        };

        socket.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        socket.onclose = () => {
            console.log("WebSocket closed.");
        };
    }

    // Handle WebSocket messages
    function handleMessage(data) {
        try {
            const parsedData = JSON.parse(data);
            if (parsedData[0] !== "EVENT") {
                console.error("Invalid message format:", parsedData);
                return;
            }

            const eventContent = parsedData[2];
            if (!eventContent || !eventContent.content) {
                console.error("Invalid event content:", eventContent);
                return;
            }

            const postContainer = document.getElementById("nostr-feed");
            if (!postContainer) throw new Error("Feed container is missing.");

            const postElement = createPostElement(eventContent);
            postContainer.appendChild(postElement);

            initializeAudioPlayers();

        } catch (error) {
            console.error("Error parsing event data:", error);
        }
    }

    // Create the post element
    function createPostElement(eventContent) {
        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");
        postElement.innerHTML = createContentHTML(eventContent);
        return postElement;
    }

    // Create HTML content for the post
    function createContentHTML(eventContent) {
        let contentHTML = `<p>${eventContent.content}</p><hr>`;
        contentHTML += insertMedia(eventContent.content);
        return contentHTML;
    }

    // Insert media content (images, videos, etc.)
    function insertMedia(content) {
        let mediaHTML = '';
        const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
        const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
        const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
        const youtubeVideoRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g);

        // Detect images
        const imageMatches = content.match(imageRegex);
        if (imageMatches) {
            imageMatches.forEach(imgUrl => {
                mediaHTML += `<img src="${imgUrl}" alt="Nostr Image">`;
            });
        }

        // Detect video
        const videoMatches = content.match(videoRegex);
        if (videoMatches) {
            videoMatches.forEach(videoUrl => {
                mediaHTML += `<div class="video-container"><video controls><source src="${videoUrl}" type="video/mp4"></video></div>`;
            });
        }

        // Detect audio
        const audioMatches = content.match(audioRegex);
        if (audioMatches) {
            audioMatches.forEach(audioUrl => {
                mediaHTML += `<div class="audio-container"><audio src="${audioUrl}"></audio></div>`;
            });
        }

        // YouTube video links
        const youtubeVideoMatches = [...content.matchAll(youtubeVideoRegex)];
        if (youtubeVideoMatches) {
            youtubeVideoMatches.forEach(match => {
                const videoId = match[2] || match[3];
                mediaHTML += `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
            });
        }
        return mediaHTML;
    }

    // Initialize audio players
    function initializeAudioPlayers() {
        document.querySelectorAll(".audio-container").forEach(container => {
            const audio = container.querySelector("audio");
            if (audio) {
                setupAudioPlayer(audio);
            }
        });
    }

    // Set up the audio player with controls
    function setupAudioPlayer(audio) {
        const seekBar = audio.parentElement.querySelector(".seek-bar");
        const timeDisplay = audio.parentElement.querySelector(".time-display");
        const playButton = audio.parentElement.querySelector(".play-button");

        audio.addEventListener("timeupdate", () => updateSeekBar(audio, seekBar, timeDisplay));
        seekBar.addEventListener("input", () => updateAudioTime(audio, seekBar));

        playButton.addEventListener("click", () => togglePlayPause(audio, playButton));
    }

    // Update seek bar based on current audio time
    function updateSeekBar(audio, seekBar, timeDisplay) {
        if (!isNaN(audio.duration)) {
            seekBar.value = (audio.currentTime / audio.duration) * 100;
            timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
        }
    }

    // Update audio time when the seek bar is moved
    function updateAudioTime(audio, seekBar) {
        audio.currentTime = (seekBar.value / 100) * audio.duration;
    }

    // Toggle play/pause on the audio player
    function togglePlayPause(audio, playButton) {
        if (audio.paused) {
            audio.play();
            playButton.textContent = "Pause";
        } else {
            audio.pause();
            playButton.textContent = "Play";
        }
    }

    // Format time in mm:ss format
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
    }

    // Initialize the polyfills and WebSocket connection
    polyfill();
    connectWebSocket();

})();
</script>




<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
