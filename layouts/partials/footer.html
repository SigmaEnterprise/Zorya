<div id="nostr-feed">
    <header>
        <h3 class="feed-title">Stream of Consciousness by npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv</h3>
        <p class="feed-description">Explore the latest thoughts, insights, and media shared in real-time. This feed presents a curated collection of posts from a dynamic, decentralized network with Nostr 'strfry' Relays as the main Database.</p>
    </header>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
async function fetchNostrFeed(pubkey, relay) {
    console.log("Connecting to relay:", relay);
    const socket = new WebSocket(relay);

    socket.onopen = () => {
        console.log("WebSocket connected!");

        const filter = {
            kinds: [1, 30023], // Only keep kinds 1 and 30023
            authors: [pubkey],
            limit: 25
        };

        socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
        console.log("Sent request:", filter);
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    socket.onmessage = (event) => {
        console.log("Received data:", event.data);
        const data = JSON.parse(event.data);
        if (data[0] !== "EVENT") return;

        const eventContent = data[2];
        const postContainer = document.getElementById("nostr-feed");

        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");

        // Convert markdown to HTML
        let contentHTML = marked.parse(eventContent.content);
        
        // Detect and insert images
        const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
        contentHTML = contentHTML.replace(imageRegex, `<img src="$1" alt="Nostr Image">`);

        // Handle video embeds (.mp4, .ogv)
        const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
        contentHTML = contentHTML.replace(videoRegex, `
            <div class="video-container">
                <video controls>
                    <source src="$1" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        `);

        // Handle YouTube video links
        const youtubeVideoRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/g;
        contentHTML = contentHTML.replace(youtubeVideoRegex, `
            <iframe src="https://www.youtube.com/embed/$1" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 1/1; border: none;"></iframe>
        `);

        // Handle audio links
        const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
        contentHTML = contentHTML.replace(audioRegex, `
            <div class="audio-container">
                <audio src="$1"></audio>
                <button class="play-button">▶ Play</button>
                <input type="range" class="seek-bar" value="0" min="0" step="1">
                <span class="time-display">0:00 / 0:00</span>
            </div>
        `);

        postElement.innerHTML = contentHTML;
        postContainer.appendChild(postElement);

        // Initialize new audio players
        setTimeout(initializeAudioPlayers, 500);
    };

    socket.onclose = () => {
        console.warn("WebSocket closed. Reconnecting in 5 seconds...");
        setTimeout(() => fetchNostrFeed(pubkey, relay), 5000);
    };
}

document.addEventListener("DOMContentLoaded", function () {
    fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", "wss://relay.damus.io");
});

// Audio Player Functions
function initializeAudioPlayers() {
    document.querySelectorAll(".audio-container").forEach(container => {
        const audio = container.querySelector("audio");
        const playButton = container.querySelector(".play-button");
        const seekBar = container.querySelector(".seek-bar");
        const timeDisplay = container.querySelector(".time-display");

        if (!audio) return;

        playButton.addEventListener("click", () => {
            if (audio.paused) {
                audio.play();
                playButton.textContent = "⏸ Pause";
            } else {
                audio.pause();
                playButton.textContent = "▶ Play";
            }
        });

        // Update Seek Bar and Time Display
        audio.addEventListener("timeupdate", () => {
            if (!isNaN(audio.duration)) {
                seekBar.value = (audio.currentTime / audio.duration) * 100;
                timeDisplay.textContent = formatTime(audio.currentTime) + " / " + formatTime(audio.duration);
            }
        });

        // Seek Audio
        seekBar.addEventListener("input", () => {
            audio.currentTime = (seekBar.value / 100) * audio.duration;
        });
    });
}

// Format Time (Seconds to MM:SS)
function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return min + ":" + (sec < 10 ? "0" + sec : sec);
}
</script>







<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
