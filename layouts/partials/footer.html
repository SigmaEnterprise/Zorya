<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
async function fetchNostrFeed(pubkey, relay) {
    console.log("Connecting to relay:", relay);
    const socket = new WebSocket(relay);

    socket.onopen = () => {
        console.log("WebSocket connected!");

        const filter = {
            kinds: [1, 66, 13194, 0], // Filter for kinds of posts
            authors: [pubkey],
            limit: 10
        };

        socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
        console.log("Sent request:", filter);
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    socket.onmessage = (event) => {
        console.log("Received data:", event.data);
        const data = JSON.parse(event.data);
        if (data[0] !== "EVENT") return;

        const eventContent = data[2];
        const postContainer = document.getElementById("nostr-feed");

        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");

        // Convert markdown to HTML
        let contentHTML = marked.parse(eventContent.content);
        
        // Detect and insert images
        contentHTML = contentHTML.replace(/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g, '<img src="$1" alt="Nostr Image">');

        // Handle video embeds
        contentHTML = contentHTML.replace(/(https?:\/\/.*\.(?:mp4|ogv))/g, '<video controls><source src="$1" type="video/mp4">Your browser does not support the video tag.</video>');

        // Handle YouTube video links
        contentHTML = contentHTML.replace(/https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+)/g, '<iframe src="https://www.youtube.com/embed/$1$2" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 1/1; border: none;"></iframe>');

        // Handle audio links
        contentHTML = contentHTML.replace(/(https?:\/\/.*\.(?:wav|mp3|ogg))/g, '<audio controls><source src="$1" type="audio/mpeg">Your browser does not support the audio tag.</audio>');

        postElement.innerHTML = contentHTML;
        postContainer.appendChild(postElement);
    };
}

async function fetchNostrProfile(nprofile) {
    const { bech32 } = await import("https://cdn.jsdelivr.net/npm/bech32@2.0.0/+esm");

    try {
        const { words } = bech32.decode(nprofile, 1000);
        const decodedData = new Uint8Array(bech32.fromWords(words));

        if (decodedData.length === 32) {
            const pubkey = Array.from(decodedData).map(byte => byte.toString(16).padStart(2, "0")).join("");
            console.log("Decoded pubkey:", pubkey);
            fetchNostrFeed(pubkey, "wss://relay.damus.io");
        }
    } catch (error) {
        console.error("Invalid bech32 nprofile:", error);
    }
}

document.addEventListener("DOMContentLoaded", function () {
    fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", "wss://relay.damus.io");
});
</script>

<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
