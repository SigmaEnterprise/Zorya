<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script>
// WebSocket connection
const socket = new WebSocket("wss://example.com/socket"); // Replace with your WebSocket URL

// Handle WebSocket connection closure
socket.onclose = () => {
    console.log("WebSocket connection closed.");
};

// Handle WebSocket error
socket.onerror = (error) => {
    console.error("WebSocket error:", error);
    // Optionally, retry or notify the user
};

// Handle WebSocket message
socket.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);
        if (data[0] !== "EVENT") {
            console.error("Invalid message format:", data);
            return;
        }

        const eventContent = data[2];
        if (!eventContent || !eventContent.content) {
            console.error("Invalid event content:", eventContent);
            return;
        }

        const postContainer = document.getElementById("nostr-feed");
        if (!postContainer) throw new Error("Feed container is missing.");

        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");
        postElement.innerHTML = createContentHTML(eventContent);
        postContainer.appendChild(postElement);

        initializeAudioPlayers(); // Initialize audio players after content is added
    } catch (error) {
        console.error("Error parsing event data:", error);
    }
};

// Create content HTML from event content
function createContentHTML(eventContent) {
    let contentHTML = `<p>${eventContent.content}</p><hr>`;
    contentHTML += insertMedia(eventContent.content); // Insert media (images, video, etc.)
    return contentHTML;
}

// Insert media such as images, videos, and audio from event content
function insertMedia(content) {
    let mediaHTML = '';
    const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
    const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
    const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
    const youtubeVideoRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g);
    
    // Detect images
    const imageMatches = content.match(imageRegex);
    if (imageMatches) {
        imageMatches.forEach(imgUrl => {
            mediaHTML += `<img src="${imgUrl}" alt="Nostr Image">`;
        });
    }
    
    // Detect video
    const videoMatches = content.match(videoRegex);
    if (videoMatches) {
        videoMatches.forEach(videoUrl => {
            mediaHTML += `<div class="video-container"><video controls><source src="${videoUrl}" type="video/mp4"></video></div>`;
        });
    }
    
    // Detect audio
    const audioMatches = content.match(audioRegex);
    if (audioMatches) {
        audioMatches.forEach(audioUrl => {
            mediaHTML += `<div class="audio-container"><audio src="${audioUrl}"></audio></div>`;
        });
    }

    // YouTube video links
    const youtubeVideoMatches = [...content.matchAll(youtubeVideoRegex)];
    if (youtubeVideoMatches) {
        youtubeVideoMatches.forEach(match => {
            const videoId = match[2] || match[3];
            mediaHTML += `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
        });
    }
    return mediaHTML;
}

// Initialize audio players with custom controls
function initializeAudioPlayers() {
    document.querySelectorAll(".audio-container").forEach(container => {
        const audio = container.querySelector("audio");
        if (audio) {
            setupAudioPlayer(audio);
        }
    });
}

// Setup custom audio player controls
function setupAudioPlayer(audio) {
    const seekBar = audio.parentElement.querySelector(".seek-bar");
    const timeDisplay = audio.parentElement.querySelector(".time-display");
    const playButton = audio.parentElement.querySelector(".play-button");

    audio.addEventListener("timeupdate", () => updateSeekBar(audio, seekBar, timeDisplay));
    seekBar.addEventListener("input", () => updateAudioTime(audio, seekBar));

    playButton.addEventListener("click", () => togglePlayPause(audio, playButton));
}

// Update the seek bar and time display
function updateSeekBar(audio, seekBar, timeDisplay) {
    if (!isNaN(audio.duration)) {
        seekBar.value = (audio.currentTime / audio.duration) * 100;
        timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
    }
}

// Update audio time based on seek bar position
function updateAudioTime(audio, seekBar) {
    audio.currentTime = (seekBar.value / 100) * audio.duration;
}

// Toggle play/pause button functionality
function togglePlayPause(audio, playButton) {
    if (audio.paused) {
        audio.play();
        playButton.textContent = "Pause";
    } else {
        audio.pause();
        playButton.textContent = "Play";
    }
}

// Format time in minutes:seconds format
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

// Delay audio initialization to ensure DOM is ready
setTimeout(initializeAudioPlayers, 500); // Wait for 500ms before initializing audio players

</script>
<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
