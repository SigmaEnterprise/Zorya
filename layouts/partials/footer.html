<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
async function fetchNostrFeed(pubkey, relay) {
    console.log("Connecting to relay:", relay);
    const socket = new WebSocket(relay);

    socket.onopen = () => {
        console.log("WebSocket connected!");

        const filter = {
            kinds: [1, 6, 16, 23], // Filter for kinds of posts
            authors: [pubkey],
            limit: 25
        };

        socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
        console.log("Sent request:", filter);
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    socket.onmessage = (event) => {
        console.log("Received data:", event.data);
        const data = JSON.parse(event.data);
        if (data[0] !== "EVENT") return;

        const eventContent = data[2];
        const postContainer = document.getElementById("nostr-feed");

        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");

        // Check if it's a repost event (kind 6)
        if (eventContent.kind === 6) {
            // A repost event has an 'e' tag referencing the reposted note
            const repostedEventId = eventContent.tags.find(tag => tag[0] === "e")[1];
            const repostContent = await fetchRepostedContent(repostedEventId, relay);

            postElement.innerHTML = `
                <div class="repost">
                    <h4>Reposted Event:</h4>
                    <p>${repostedContent}</p>
                    <p><strong>Reposted by:</strong> ${eventContent.pubkey}</p>
                </div>
            `;
        } else {
            // Regular content processing (e.g., kind 1, 16, 23)
            let contentHTML = marked.parse(eventContent.content);

            // Handle embedded media (images, videos, audio)
            contentHTML += handleMedia(eventContent.content);

            postElement.innerHTML = contentHTML;
        }

        postContainer.appendChild(postElement);
    };
}

async function fetchRepostedContent(eventId, relay) {
    // Function to fetch reposted event content by its ID
    console.log("Fetching reposted content for event:", eventId);
    const socket = new WebSocket(relay);
    return new Promise((resolve, reject) => {
        socket.onopen = () => {
            const filter = {
                kinds: [1], // Kind 1 for text notes
                ids: [eventId]
            };

            socket.send(JSON.stringify(["REQ", "reposted-content", filter]));
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data[0] === "EVENT" && data[2].id === eventId) {
                resolve(data[2].content);
            }
        };

        socket.onerror = (error) => {
            reject(error);
        };
    });
}

function handleMedia(content) {
    let mediaHTML = "";

    // Handle images
    const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
    const imageMatches = content.match(imageRegex);
    if (imageMatches) {
        imageMatches.forEach(imgUrl => {
            mediaHTML += `<img src="${imgUrl}" alt="Nostr Image">`;
        });
    }

    // Handle video embeds
    const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
    const videoMatches = content.match(videoRegex);
    if (videoMatches) {
        videoMatches.forEach(videoUrl => {
            mediaHTML += `
                <div class="video-container">
                    <video controls>
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>`;
        });
    }

    // Handle YouTube video links
    const youtubeVideoRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g;
    const youtubeVideoMatches = [...content.matchAll(youtubeVideoRegex)];
    if (youtubeVideoMatches) {
        youtubeVideoMatches.forEach(match => {
            const videoId = match[2] || match[3];
            mediaHTML += `<br><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 1/1; border: none;"></iframe>`;
        });
    }

    // Handle audio links
    const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
    const audioMatches = content.match(audioRegex);
    if (audioMatches) {
        audioMatches.forEach(audioUrl => {
            mediaHTML += `
                <div class="audio-container">
                    <audio id="audio-player" src="${audioUrl}"></audio>
                    <div class="audio-controls">
                        <button class="play-button" onclick="togglePlay(this)">▶ Play</button>
                        <input type="range" class="seek-bar" value="0" min="0" step="1" oninput="seekAudio(this)">
                        <span class="time-display">0:00 / 0:00</span>
                    </div>
                </div>`;
        });
    }

    return mediaHTML;
}

document.addEventListener("DOMContentLoaded", function () {
    fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", "wss://relay.damus.io");
});

// Audio Player Functions
function togglePlay(button) {
    const audio = button.parentElement.parentElement.querySelector("audio");
    if (audio.paused) {
        audio.play();
        button.textContent = "⏸ Pause";
    } else {
        audio.pause();
        button.textContent = "▶ Play";
    }
}

function seekAudio(seekBar) {
    const audio = seekBar.parentElement.parentElement.querySelector("audio");
    audio.currentTime = (seekBar.value / 100) * audio.duration;
}
</script>
<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
