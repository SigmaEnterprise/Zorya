<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
async function fetchNostrFeed(pubkey, relay) {
    console.log("Connecting to relay:", relay);
    const socket = new WebSocket(relay);
    let events = [];

    socket.onopen = () => {
        console.log("WebSocket connected!");

        const filter = {
            kinds: [1, 0, 30023], // Posts, profile, and other events
            authors: [pubkey],
            limit: 10
        };

        socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
        console.log("Sent request:", filter);
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    socket.onmessage = (event) => {
        console.log("Received data:", event.data);
        const data = JSON.parse(event.data);
        if (data[0] !== "EVENT") return;

        const eventContent = data[2];
        
        // Ensure profile (kind 0) replaces any existing one, and other events appear newest first
        if (eventContent.kind === 0) {
            events = events.filter(e => e.kind !== 0);
        }

        events.unshift(eventContent); // Add newest events to the beginning

        renderEvents(events);
    };
}

function renderEvents(events) {
    const postContainer = document.getElementById("nostr-feed");
    postContainer.innerHTML = ""; // Clear previous content

    // Ensure profile (kind 0) appears first
    events.sort((a, b) => (a.kind === 0 ? -1 : 1));

    events.forEach(eventContent => {
        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");

        if (eventContent.kind === 0) {
            // Profile Event (kind 0)
            const profile = JSON.parse(eventContent.content);
            postElement.innerHTML = `
                <div class="profile">
                    <h2>${profile.name || "Unnamed User"}</h2>
                    <p>${profile.about || ""}</p>
                    ${profile.picture ? `<img src="${profile.picture}" alt="Profile Picture">` : ""}
                </div>
            `;
        } else {
            // Post Event (kind 1)
            let contentHTML = marked.parse(eventContent.content);

            // Detect and insert images
            const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
            const imageMatches = eventContent.content.match(imageRegex);
            if (imageMatches) {
                imageMatches.forEach(imgUrl => {
                    contentHTML += `<img src="${imgUrl}" alt="Nostr Image">`;
                });
            }

            // Handle video embeds
            const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
            const videoMatches = eventContent.content.match(videoRegex);
            if (videoMatches) {
                videoMatches.forEach(videoUrl => {
                    contentHTML += `
                        <div class="video-container">
                            <video controls>
                                <source src="${videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                });
            }

            postElement.innerHTML = contentHTML;
        }

        postContainer.appendChild(postElement); // Append all events to the container
    });
}

document.addEventListener("DOMContentLoaded", function () {
    fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", "wss://relay.damus.io");
});
</script>



<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
