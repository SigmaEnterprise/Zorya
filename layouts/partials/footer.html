<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Initialize WebSocket
const socket = new WebSocket("ws://your-websocket-url");

// Function to toggle audio play/pause
function togglePlay(button) {
    const audio = button.closest('.audio-container').querySelector('audio');
    if (audio.paused) {
        audio.play();
        button.textContent = "⏸ Pause";
    } else {
        audio.pause();
        button.textContent = "▶ Play";
    }
}

// Function to update audio time display
function updateAudioTime(audio) {
    const timeDisplay = audio.closest('.audio-container').querySelector('.time-display');
    const seekBar = audio.closest('.audio-container').querySelector('.seek-bar');
    const currentTime = audio.currentTime;
    const duration = audio.duration;

    const minutes = Math.floor(currentTime / 60);
    const seconds = Math.floor(currentTime % 60);
    const formattedTime = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
    timeDisplay.textContent = `${formattedTime} / ${Math.floor(duration / 60)}:${Math.floor(duration % 60)}`;

    // Update the seek bar
    seekBar.value = (currentTime / duration) * 100;
}

// Function to initialize audio players
function initializeAudioPlayers() {
    const audioPlayers = document.querySelectorAll('audio');
    audioPlayers.forEach(audio => {
        audio.addEventListener('timeupdate', () => updateAudioTime(audio));
    });
}

// Handle incoming WebSocket messages
socket.onmessage = (event) => {
    console.log("Received data:", event.data);
    const data = JSON.parse(event.data);
    if (data[0] !== "EVENT") return;

    const eventContent = data[2];
    const postContainer = document.getElementById("nostr-feed");

    // Check for profile event (kind === 0)
    if (eventContent.kind === 0) {
        const profileElement = document.createElement("div");
        profileElement.classList.add("profile-item");

        // Convert profile markdown to HTML
        let profileContent = marked.parse(eventContent.content);
        profileElement.innerHTML = profileContent;

        // Prepend profile to the feed
        postContainer.prepend(profileElement);
    }

    // Process regular posts
    if (eventContent.kind !== 0) {
        const postElement = document.createElement("div");
        postElement.classList.add("feed-item");

        // Convert markdown to HTML
        let contentHTML = marked.parse(eventContent.content);

        // Handle image links
        const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
        const imageMatches = eventContent.content.match(imageRegex);
        if (imageMatches) {
            imageMatches.forEach(imgUrl => {
                contentHTML += `<img src="${imgUrl}" alt="Nostr Image">`;
            });
        }

        // Handle video links (mp4, ogv)
        const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
        const videoMatches = eventContent.content.match(videoRegex);
        if (videoMatches) {
            videoMatches.forEach(videoUrl => {
                contentHTML += 
                    `<div class="video-container">
                        <video controls>
                            <source src="${videoUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>`;
            });
        }

        // Handle YouTube links
        const youtubeVideoRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g;
        const youtubeVideoMatches = [...eventContent.content.matchAll(youtubeVideoRegex)];
        if (youtubeVideoMatches) {
            youtubeVideoMatches.forEach(match => {
                const videoId = match[2] || match[3];
                contentHTML += `<br><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 1/1; border: none;"></iframe>`;
            });
        }

        // Handle audio links (wav, mp3, ogg)
        const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
        const audioMatches = eventContent.content.match(audioRegex);
        if (audioMatches) {
            audioMatches.forEach(audioUrl => {
                contentHTML += 
                    `<div class="audio-container">
                        <audio id="audio-player" src="${audioUrl}"></audio>
                        <div class="audio-controls">
                            <button class="play-button" onclick="togglePlay(this)">▶ Play</button>
                            <input type="range" class="seek-bar" value="0" min="0" step="1" oninput="seekAudio(this)">
                            <span class="time-display">0:00 / 0:00</span>
                        </div>
                    </div>`;
            });
        }

        postElement.innerHTML = contentHTML;
        postContainer.appendChild(postElement);

        // Initialize new audio players
        setTimeout(initializeAudioPlayers, 500);
    }
};

// Function to handle audio seek bar
function seekAudio(seekBar) {
    const audio = seekBar.closest('.audio-container').querySelector('audio');
    audio.currentTime = (seekBar.value / 100) * audio.duration;
}

</script>



<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
