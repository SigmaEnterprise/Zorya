<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script>
async function fetchRelayInfo(relay) {
    try {
        console.log("Fetching relay info:", relay);
        const response = await fetch(relay.replace("wss://", "https://"));

        if (!response.ok) {
            throw new Error(`Relay responded with status: ${response.status}`);
        }

        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            throw new Error("Relay response is not valid JSON.");
        }

        const data = await response.json();
        console.log("Relay info:", data);
        return data.name || relay;
    } catch (error) {
        console.error("Failed to fetch relay info:", error);
        return relay;
    }
}

async function fetchNostrFeed(pubkey, relays) {
    const postContainer = document.getElementById("nostr-feed");
    postContainer.innerHTML = "";

    for (const relay of relays) {
        const relayName = await fetchRelayInfo(relay);
        console.log("Connecting to:", relayName);

        const socket = new WebSocket(relay);

        socket.onopen = () => {
            console.log("Connected to", relayName);
            socket.send(JSON.stringify(["REQ", "nostr-feed", { kinds: [1, 66, 13194, 0], authors: [pubkey], limit: 10 }]));
        };

        socket.onerror = (error) => console.error("WebSocket error:", error);

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data[0] !== "EVENT") return;

                const eventContent = data[2];
                const postElement = document.createElement("div");
                postElement.classList.add("feed-item");
                
                let contentHTML = `<p>${eventContent.content}</p><hr>`;

                const mediaTypes = {
                    images: /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g,
                    videos: /(https?:\/\/.*\.(?:mp4|ogv))/g,
                    youtube: /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g,
                    audio: /(https?:\/\/.*\.(?:wav|mp3|ogg))/g
                };

                const matches = {
                    images: eventContent.content.match(mediaTypes.images),
                    videos: eventContent.content.match(mediaTypes.videos),
                    youtube: [...eventContent.content.matchAll(mediaTypes.youtube)],
                    audio: eventContent.content.match(mediaTypes.audio)
                };

                if (matches.images) matches.images.forEach(imgUrl => contentHTML += `<img src="${imgUrl}" alt="Nostr Image">`);
                if (matches.videos) matches.videos.forEach(videoUrl => contentHTML += `<video controls><source src="${videoUrl}" type="video/mp4"></video>`);
                if (matches.youtube) matches.youtube.forEach(match => {
                    const videoId = match[2] || match[3];
                    contentHTML += `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
                });
                if (matches.audio) matches.audio.forEach(audioUrl => contentHTML += `<audio controls><source src="${audioUrl}"></audio>`);

                postElement.innerHTML = contentHTML;
                postContainer.appendChild(postElement);
            } catch (err) {
                console.error("Error processing message:", err);
            }
        };
    }
}

document.addEventListener("DOMContentLoaded", function () {
    const relays = ["wss://relay.damus.io", "wss://libretechsystems.nostr1.com"];
    fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", relays);
});
</script>





<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
