<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
 <script>
        async function fetchNostrFeed() {
            const pubkey = document.getElementById("pubkey").value;
            const relay = document.getElementById("relay").value;
            const status = document.getElementById("status");
            status.textContent = "Connecting...";

            console.log("Connecting to relay:", relay);
            const socket = new WebSocket(relay);

            socket.onopen = () => {
                console.log("WebSocket connected!");
                status.textContent = "Fetching posts...";

                const filter = {
                    kinds: [1, 66, 13194, 0], // Post types
                    authors: [pubkey],
                    limit: 10
                };

                socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
                console.log("Sent request:", filter);
            };

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
                status.textContent = "Connection failed.";
            };

            socket.onmessage = (event) => {
                console.log("Received data:", event.data);
                const data = JSON.parse(event.data);
                if (data[0] !== "EVENT") return;

                const eventContent = data[2];
                const postContainer = document.getElementById("nostr-feed");
                postContainer.innerHTML = "";

                const postElement = document.createElement("div");
                postElement.classList.add("feed-item");

                // Convert Markdown to HTML
                let contentHTML = marked.parse(eventContent.content);

                // Detect and insert images
                const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
                const imageMatches = eventContent.content.match(imageRegex);
                if (imageMatches) {
                    imageMatches.forEach(imgUrl => {
                        contentHTML += `<img src="${imgUrl}" alt="Nostr Image" style="max-width:100%; margin-top:5px;">`;
                    });
                }

                // Handle videos
                const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
                const videoMatches = eventContent.content.match(videoRegex);
                if (videoMatches) {
                    videoMatches.forEach(videoUrl => {
                        contentHTML += `<video controls style="width:100%; margin-top:5px;"><source src="${videoUrl}" type="video/mp4"></video>`;
                    });
                }

                // Handle YouTube videos
                const youtubeRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g;
                const youtubeMatches = [...eventContent.content.matchAll(youtubeRegex)];
                if (youtubeMatches) {
                    youtubeMatches.forEach(match => {
                        const videoId = match[2] || match[3];
                        contentHTML += `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen style="width:100%; aspect-ratio:16/9; border:none;"></iframe>`;
                    });
                }

                // Handle audio
                const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
                const audioMatches = eventContent.content.match(audioRegex);
                if (audioMatches) {
                    audioMatches.forEach(audioUrl => {
                        contentHTML += `
                            <div class="audio-container">
                                <audio controls style="width:100%;">
                                    <source src="${audioUrl}" type="audio/mpeg">
                                </audio>
                            </div>`;
                    });
                }

                // Add copy to clipboard button
                contentHTML += `<button class="copy-btn" onclick="copyToClipboard('${eventContent.content}')">üìã Copy</button>`;

                postElement.innerHTML = contentHTML;
                postContainer.appendChild(postElement);
                status.textContent = "";
            };

            setTimeout(fetchNostrFeed, 30000); // Auto-refresh every 30 sec
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Copied to clipboard!");
            }).catch(err => {
                console.error("Copy failed:", err);
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }

        document.addEventListener("DOMContentLoaded", function () {
            fetchNostrFeed(); // Auto-fetch on page load
        });
    </script>


<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ‚ö°Ô∏è
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo  ï‚Ä¢·¥•‚Ä¢ î Bear</a>{{ end }}
