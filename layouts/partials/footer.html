<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script>
    let refreshInterval = 30000; // 30 seconds
    let autoRefresh;

    function fetchNostrFeed() {
        const pubkey = document.getElementById("pubkey-input").value.trim();
        const relay = document.getElementById("relay-select").value;
        const postContainer = document.getElementById("nostr-feed");
        const errorMessage = document.getElementById("error-message");

        if (!pubkey) {
            errorMessage.textContent = "Please enter a valid Nostr public key.";
            return;
        }

        errorMessage.textContent = "";
        postContainer.innerHTML = ""; // Clear feed

        console.log("Connecting to relay:", relay);
        const socket = new WebSocket(relay);

        socket.onopen = () => {
            console.log("WebSocket connected!");

            const filter = {
                kinds: [1, 66, 13194, 0], // Post kinds
                authors: [pubkey],
                limit: 10
            };

            socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
            console.log("Sent request:", filter);
        };

        socket.onerror = (error) => {
            console.error("WebSocket error:", error);
            errorMessage.textContent = "Connection error. Please try another relay.";
        };

        socket.onmessage = (event) => {
            console.log("Received data:", event.data);
            const data = JSON.parse(event.data);
            if (data[0] !== "EVENT") return;

            const eventContent = data[2];

            if (!eventContent || !eventContent.content) {
                errorMessage.textContent = "No posts found.";
                return;
            }

            const postElement = document.createElement("div");
            postElement.classList.add("feed-item");

            // Convert markdown to HTML with emoji support
            let contentHTML = marked.parse(eventContent.content, { gfm: true, breaks: true });

            // Process media content (images, videos, YouTube, audio)
            contentHTML = processContent({ content: contentHTML });

            // Copy to Clipboard Button
            contentHTML += `<button class="copy-btn" onclick="copyToClipboard('${eventContent.content.replace(/'/g, "\\'")}')">Copy</button>`;

            postElement.innerHTML = contentHTML;
            postContainer.appendChild(postElement);
        };

        // Auto Refresh
        clearInterval(autoRefresh);
        autoRefresh = setInterval(fetchNostrFeed, refreshInterval);
    }

    // Function to detect and insert media (images, videos, YouTube, audio)
    function processContent(eventContent) {
        let contentHTML = eventContent.content;

        // Detect and insert images
        const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
        contentHTML = contentHTML.replace(imageRegex, imgUrl => `<img src="${imgUrl}" alt="Nostr Image">`);

        // Handle video embeds (.mp4, .ogv)
        const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
        contentHTML = contentHTML.replace(videoRegex, videoUrl =>
            `<div class="video-container">
                <video controls>
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>`);

        // Handle YouTube video links
        const youtubeVideoRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g;
        contentHTML = contentHTML.replace(youtubeVideoRegex, (match, p1, videoId) =>
            `<br><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 1/1; border: none;"></iframe>`);

        // Handle audio links
        const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
        contentHTML = contentHTML.replace(audioRegex, audioUrl =>
            `<div class="audio-container">
                <audio controls>
                    <source src="${audioUrl}" type="audio/mp3">
                    Your browser does not support the audio element.
                </audio>
            </div>`);

        return contentHTML;
    }

    function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert("Copied to clipboard!");
        }).catch(err => {
            console.error("Failed to copy:", err);
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        fetchNostrFeed();
    });
</script>


<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
