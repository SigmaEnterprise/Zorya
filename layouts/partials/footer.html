<div id="nostr-feed">
    <h3>Nostr Feed</h3>
</div>
<script>
async function fetchNostrFeed(pubkey, relay) {
    console.log("Connecting to relay:", relay);
    const socket = new WebSocket(relay);

    socket.onopen = () => {
        console.log("WebSocket connected!");

        const filter = {
            kinds: [1, 66, 13194, 0], // Filter for kinds of posts
            authors: [pubkey],
            limit: 10
        };

        socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
        console.log("Sent request:", filter);
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
        alert("An error occurred while connecting to the relay. Please try again later.");
    };

    socket.onmessage = (event) => {
        try {
            console.log("Received data:", event.data);
            const data = JSON.parse(event.data);

            // Validate event
            if (data[0] !== "EVENT") return;

            const eventContent = data[2];

            if (!eventContent?.content) {
                console.error("Invalid event content:", eventContent);
                return;
            }

            displayPost(eventContent.content);

        } catch (error) {
            console.error("Error parsing event data:", error);
        }
    };
}

// Display Post
function displayPost(content) {
    const postContainer = document.getElementById("nostr-feed");
    const postElement = document.createElement("div");
    postElement.classList.add("feed-item");

    let contentHTML = `<p>${content}</p><hr>`;

    // Detect and insert media content (images, video, audio, etc.)
    contentHTML += insertMedia(content);

    postElement.innerHTML = contentHTML;
    postContainer.appendChild(postElement);

    // Initialize new audio players
    setTimeout(initializeAudioPlayers, 500);
}

// Insert Media: Handles all media types (image, video, audio, YouTube, M3U)
function insertMedia(content) {
    let mediaHTML = '';

    mediaHTML += insertImages(content);
    mediaHTML += insertVideos(content);
    mediaHTML += insertAudio(content);
    mediaHTML += insertYouTube(content);
    mediaHTML += insertM3U(content);

    return mediaHTML;
}

// Insert Image URLs
function insertImages(content) {
    const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
    const imageMatches = content.match(imageRegex);
    if (!imageMatches) return '';

    return imageMatches.map(imgUrl => `<img src="${imgUrl}" alt="Nostr Image">`).join('');
}

// Insert Video URLs
function insertVideos(content) {
    const videoRegex = /(https?:\/\/.*\.(?:mp4|ogv))/g;
    const videoMatches = content.match(videoRegex);
    if (!videoMatches) return '';

    return videoMatches.map(videoUrl => 
        `<div class="video-container">
            <video controls>
                <source src="${videoUrl}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>`
    ).join('');
}

// Insert YouTube Links
function insertYouTube(content) {
    const youtubeVideoRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([\w-]+)|https?:\/\/youtu\.be\/([\w-]+))/g;
    const youtubeVideoMatches = [...content.matchAll(youtubeVideoRegex)];

    if (!youtubeVideoMatches.length) return '';

    return youtubeVideoMatches.map(match => {
        const videoId = match[2] || match[3];
        return `<br><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 1/1; border: none;"></iframe>`;
    }).join('');
}

// Insert Audio URLs (MP3, WAV, OGG)
function insertAudio(content) {
    const audioRegex = /(https?:\/\/.*\.(?:wav|mp3|ogg))/g;
    const audioMatches = content.match(audioRegex);
    if (!audioMatches) return '';

    return audioMatches.map(audioUrl => 
        `<div class="audio-container">
            <audio src="${audioUrl}"></audio>
            <div class="audio-controls">
                <button class="play-button" onclick="togglePlay(this)">▶ Play</button>
                <input type="range" class="seek-bar" value="0" min="0" step="1" oninput="seekAudio(this)">
                <span class="time-display">0:00 / 0:00</span>
            </div>
        </div>`
    ).join('');
}

// Insert M3U Playlist Embeds
function insertM3U(content) {
    const m3uRegex = /(https?:\/\/.*\.m3u)/g;
    const m3uMatches = content.match(m3uRegex);
    if (!m3uMatches) return '';

    return m3uMatches.map(m3uUrl => 
        `<div class="m3u-container">
            <iframe src="https://archive.org/embed/${m3uUrl.split('/').pop().replace('.m3u', '')}" width="500" height="60" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" allowfullscreen></iframe>
        </div>`
    ).join('');
}

document.addEventListener("DOMContentLoaded", function () {
    fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", "wss://relay.damus.io");
});

// Audio Player Functions
function togglePlay(button) {
    const audio = button.closest('.audio-container').querySelector("audio");
    if (audio.paused) {
        audio.play();
        button.textContent = "⏸ Pause";
    } else {
        audio.pause();
        button.textContent = "▶ Play";
    }
}

function seekAudio(seekBar) {
    const audio = seekBar.closest('.audio-container').querySelector("audio");
    audio.currentTime = (seekBar.value / 100) * audio.duration;
}

function initializeAudioPlayers() {
    document.querySelectorAll(".audio-container").forEach(container => {
        const audio = container.querySelector("audio");
        const playButton = container.querySelector(".play-button");
        const seekBar = container.querySelector(".seek-bar");
        const timeDisplay = container.querySelector(".time-display");

        if (!audio) return;

        // Update Seek Bar and Time Display
        audio.addEventListener("timeupdate", () => {
            if (!isNaN(audio.duration)) {
                seekBar.value = (audio.currentTime / audio.duration) * 100;
                timeDisplay.textContent = formatTime(audio.currentTime) + " / " + formatTime(audio.duration);
            }
        });

        // Seek Audio
        seekBar.addEventListener("input", () => {
            audio.currentTime = (seekBar.value / 100) * audio.duration;
        });
    });
}

// Format Time (Seconds to MM:SS)
function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return min + ":" + (sec < 10 ? "0" + sec : sec);
}
</script>




<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
