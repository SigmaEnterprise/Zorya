<div id="nostr-feed">
    <header>
        <h3 class="feed-title">Stream of Consciousness by npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv</h3>
        <p class="feed-description">Explore the latest thoughts, insights, and media shared in real-time. This feed presents a curated collection of posts from a dynamic, decentralized network with Nostr 'strfry' Relays as the main Database.</p>
    </header>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
// Passive event listeners fix
document.addEventListener("touchstart", () => {}, { passive: true });
document.addEventListener("wheel", () => {}, { passive: true });

let socket;
let lastEventId = new Set(); // Prevent duplicate posts

// Fetching Nostr Feed
function fetchNostrFeed(pubkey, relay) {
    console.log("Connecting to relay:", relay);
    socket = new WebSocket(relay);

    socket.onopen = () => {
        console.log("WebSocket connected!");

        const filter = {
            kinds: [1, 6, 16, 30023, 66, 13194], // Filter for kinds of posts
            authors: [pubkey],
            limit: 25
        };

        socket.send(JSON.stringify(["REQ", "nostr-feed", filter]));
        console.log("Sent request:", filter);
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    socket.onmessage = (event) => {
        console.log("Received data:", event.data);
        processEvent(event.data);
    };

    socket.onclose = () => {
        console.warn("WebSocket closed. Reconnecting in 5 seconds...");
        setTimeout(() => fetchNostrFeed(pubkey, relay), 5000);
    };
}

// Process WebSocket events without redundant re-parsing
function processEvent(data) {
    try {
        const parsedData = JSON.parse(data);
        if (parsedData[0] !== "EVENT" || !parsedData[2]?.id) return;

        const eventContent = parsedData[2];
        if (lastEventId.has(eventContent.id)) return; // Avoid duplicates
        lastEventId.add(eventContent.id);

        renderPost(eventContent.content);
    } catch (error) {
        console.error("Error processing WebSocket message:", error);
    }
}

// Render post without adding duplicate event listeners
function renderPost(content) {
    const postContainer = document.getElementById("nostr-feed");
    const postElement = document.createElement("div");
    postElement.classList.add("feed-item");

    let contentHTML = marked.parse(content);

    // Detect and insert images
    contentHTML = contentHTML.replace(/(https?:\/\/\S+\.(png|jpe?g|gif))/gi, '<img src="$1" alt="Nostr Image">');

    // Handle video embeds
    contentHTML = contentHTML.replace(/(https?:\/\/\S+\.(mp4|ogv))/gi, `
        <div class="video-container">
            <video controls>
                <source src="$1" type="video/$2">
                Your browser does not support the video tag.
            </video>
        </div>
    `);

    // Handle YouTube video links
    contentHTML = contentHTML.replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/gi, `
        <iframe src="https://www.youtube.com/embed/$1" allowfullscreen style="width: 100%; height: 100%; aspect-ratio: 16/9; border: none;"></iframe>
    `);

    // Handle audio links
    contentHTML = contentHTML.replace(/(https?:\/\/\S+\.(mp3|wav|ogg))/gi, `
        <div class="audio-container">
            <audio src="$1"></audio>
            <button class="play-button">▶ Play</button>
        </div>
    `);

    postElement.innerHTML = contentHTML;
    postContainer.appendChild(postElement);
}

// Efficient event syncing using MutationObserver
const observer = new MutationObserver(() => {
    document.querySelectorAll(".play-button").forEach(button => {
        if (!button.dataset.listenerAdded) {
            button.dataset.listenerAdded = "true";
            button.addEventListener("click", togglePlay);
        }
    });
});

// Start observing new elements added to #nostr-feed
observer.observe(document.getElementById("nostr-feed"), { childList: true });

function togglePlay(event) {
    const button = event.target;
    const audio = button.previousElementSibling;
    if (audio.paused) {
        audio.play();
        button.textContent = "⏸ Pause";
    } else {
        audio.pause();
        button.textContent = "▶ Play";
    }
}

// Start fetching the feed
fetchNostrFeed("d34e832d42ad8b93c1a1c3c8400934405f30bcbf857f39ea2f008c26383f78d0", "wss://relay.damus.io");
</script>






<button
    data-npub="npub16d8gxt2z4k9e8sdpc0yyqzf5gp0np09ls4lnn630qzxzvwpl0rgq5h4rzv"
    data-relays="wss://relay.damus.io,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.band,wss://nos.lol"
>
    Zap Me ⚡️
</button>

<script src="https://cdn.jsdelivr.net/npm/nostr-zap@0.22.0"></script>

{{ if ne .Site.Params.hideMadeWithLine true }}Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>{{ end }}
